# Android4.4 报SSLHandshakeException

#### 【问题描述】

终端apk采用HTTPSURLConnection发送POST接口，在发送请求时出现Exception

#### 【问题日志】

09-22 15:30:03.717 E/CustomClient( 8699): [javax.net](http://javax.net/).ssl.SSLHandshakeException: [javax.net](http://javax.net/).ssl.SSLProtocolException: SSL handshake aborted: ssl=0x48572270: Failure in SSL library, usually a protocol error
09-22 15:30:03.717 E/CustomClient( 8699): error:14077410:SSL routines:SSL23_GET_SERVER_HELLO:sslv3 alert handshake failure (external/openssl/ssl/s23_clnt.c:744 0x485a9d5c:0x00000000)

#### 【问题分析】

\1. 从测试结果看，Android4.4的设备存在问题，而Android5的设备表现正常。从网上搜索的资源看，Android5以下设备是不是默认支持TLSv1.2协议，需要手动开启。通过重载SSLSocketFactory确实可以正常打开，但是连接时依然报握手异常。

2.分析Ngnix上配置的ssl_ciphers和Android上SSLSocket支持的ciphers（getSupportedCipherSuites）发现没有相同的

3.进而在Ngnix上执行openssl ciphers查看，发现和Android上SSLSocket支持的ciphers也没有啥相同的

**OpenSSL> ciphers ALL**
**ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DH-DSS-AES256-GCM-SHA384:DHE-DSS-AES256-GCM-SHA384:DH-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA256:DH-RSA-AES256-SHA256:DH-DSS-AES256-SHA256:DHE-RSA-AES256-SHA:DHE-DSS-AES256-SHA:DH-RSA-AES256-SHA:DH-DSS-AES256-SHA:DHE-RSA-CAMELLIA256-SHA:DHE-DSS-CAMELLIA256-SHA:DH-RSA-CAMELLIA256-SHA:DH-DSS-CAMELLIA256-SHA:AECDH-AES256-SHA:ADH-AES256-GCM-SHA384:ADH-AES256-SHA256:ADH-AES256-SHA:ADH-CAMELLIA256-SHA:ECDH-RSA-AES256-GCM-SHA384:ECDH-ECDSA-AES256-GCM-SHA384:ECDH-RSA-AES256-SHA384:ECDH-ECDSA-AES256-SHA384:ECDH-RSA-AES256-SHA:ECDH-ECDSA-AES256-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA:CAMELLIA256-SHA:PSK-AES256-CBC-SHA:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:DH-DSS-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:DH-RSA-AES128-GCM-SHA256:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES128-SHA256:DHE-DSS-AES128-SHA256:DH-RSA-AES128-SHA256:DH-DSS-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA:DH-RSA-AES128-SHA:DH-DSS-AES128-SHA:DHE-RSA-SEED-SHA:DHE-DSS-SEED-SHA:DH-RSA-SEED-SHA:DH-DSS-SEED-SHA:DHE-RSA-CAMELLIA128-SHA:DHE-DSS-CAMELLIA128-SHA:DH-RSA-CAMELLIA128-SHA:DH-DSS-CAMELLIA128-SHA:AECDH-AES128-SHA:ADH-AES128-GCM-SHA256:ADH-AES128-SHA256:ADH-AES128-SHA:ADH-SEED-SHA:ADH-CAMELLIA128-SHA:ECDH-RSA-AES128-GCM-SHA256:ECDH-ECDSA-AES128-GCM-SHA256:ECDH-RSA-AES128-SHA256:ECDH-ECDSA-AES128-SHA256:ECDH-RSA-AES128-SHA:ECDH-ECDSA-AES128-SHA:AES128-GCM-SHA256:AES128-SHA256:AES128-SHA:SEED-SHA:CAMELLIA128-SHA:PSK-AES128-CBC-SHA:ECDHE-RSA-DES-CBC3-SHA:ECDHE-ECDSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:EDH-DSS-DES-CBC3-SHA:DH-RSA-DES-CBC3-SHA:DH-DSS-DES-CBC3-SHA:AECDH-DES-CBC3-SHA:ADH-DES-CBC3-SHA:ECDH-RSA-DES-CBC3-SHA:ECDH-ECDSA-DES-CBC3-SHA:DES-CBC3-SHA:IDEA-CBC-SHA:PSK-3DES-EDE-CBC-SHA:KRB5-IDEA-CBC-SHA:KRB5-DES-CBC3-SHA:KRB5-IDEA-CBC-MD5:KRB5-DES-CBC3-MD5:ECDHE-RSA-RC4-SHA:ECDHE-ECDSA-RC4-SHA:AECDH-RC4-SHA:ADH-RC4-MD5:ECDH-RSA-RC4-SHA:ECDH-ECDSA-RC4-SHA:RC4-SHA:RC4-MD5:PSK-RC4-SHA:KRB5-RC4-SHA:KRB5-RC4-MD5**

基于这个现象，在Ngnix上对ssl_ciphers进行修改测试，最终发现例如“RSA+AES+SHA1”、“SSLv3”都是可行的。

#### 【结论】

从目前测试结果看，对于Android4.4与Ngnix TLS1.2的连接有2个问题：

1.Android需要手动开启TLSv1.2,（示例代码见附录）

2.加密套件是由服务端决定的，服务端需要配置的加密套件需要兼容Android4.4的旧客户端，当前普遍采用的SHA2摘要在Android4.4（getSupportedCipherSuites）上并不支持。可以增加配置"RSA+AES+SHA1"

#### 【附录】

##### Ngnix ssl_ciphers配置：

**Openssl定义了4中选择符号：“+”，“-”，“!”，“@”。其中，“+”表示取交集；“-”表示临时删除一个算法；“!”表示永久删除一个算法；“@“表示了排序方法。**

多个描述之间可以用“:”或“,”或空格或“;”来分开。选择加密套件的时候按照从左到的右顺序构成双向链表，存放与内存中。

```css
ALL:!DH:RC4+RSA:+SSLv2:@STRENGTH
```

表示的意义是：首先选择所有的加密套件，然后在得到的双向链表之中去掉密钥交换采用DH的加密套件；加入包含RC4对称加密算法与RSA身份认证算法的交集加密套件；再将支持老版本SSLv2的加密套件放在尾部；最后,`@STRENGTH`表示将得到的结果按照安全强度进行排序。

参数可以参考官方API：<https://www.openssl.org/docs/man1.0.2/man1/ciphers.html> 



##### Android4.4手动开启TLSv1.2示例：

自定义SSLSocketFactory：

```java

```

使用自定义SSLSocketFactory：

```java

```
